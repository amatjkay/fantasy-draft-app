# REQUIREMENTS.md (Fantasy Draft App, актуальная редакция 22.10.2025)

## 1. Общая концепция

Fantasy Draft App предназначен для проведения еженедельных драфтов по хоккею (NHL) с режимом “salary cap”, мультипозиционной поддержкой игроков и автоматическим подсчетом очков по детализированной скоринговой формуле. Каждый цикл — одна активная драфт-комната, очки аккумулируются в еженедельный leaderboard и суммируются в общий сезонный рейтинг.

## 2. Архитектура бизнес-логики

### 2.1 Роли и доступ

- **Admin:** Организация лобби и драфта (запуск драфта, пауза/продолжить, kick), управление пользователями (логин, роль, команда, пароль). Вмешательство в логику драфта запрещено: нет force-pick и нет undo.
- **Участник:** Вход в комнату, драфт пики, просмотр команд/лидера, reconnect при сбое.
- **Гость:** Только просмотр.

### 2.2 Комнатная модель и драфт

- **Одна комната** (Draft Room) на текущую неделю. Комната создается админом.
- **Запуск драфта** — по команде админа.
- **6 раундов, snake draft**: Порядок — змейкой; для каждого участника — один ход за раунд.
- **Размер ростера**: 6 позиций (LW, C, RW, D, D, G).
- **Мультипозиция**: Игрок может быть выбран только в ОДИН слот по eligiblePositions; если игрок C/LW — можно поставить только на LW или только на C, но не дважды.
- **Salary cap**: \$95,000,000. Превышение невозможно, пик блокируется.

### 2.3 Логика пика, таймеры и reconnect

- **Таймер на пик**: 60 сек серверного отсчёта.
- При disconnect — запускается grace period 60 сек (статус reconnect виден всем), при успешном возврате — возобновление таймера; при истечении — авто‑пик с учётом позиций и salary cap.
- Forced-pick/undo не поддерживаются по требованиям.
- Нестандартные действия (reconnect, гонки auto-pick/user-pick) отображаются в UI через специндикаторы.

***

## 3. Данные и интеграции

### 3.1 Игроки и пул данных

- **Источники**: NHL Official API (при ошибках — fallback на ESPN/Capwages).
- **Парсинг данных**: Cron job каждые 3 часа.
- **Структура**: ФИО, команда, eligiblePositions (масcив C/LW/RW/D/G), salary, injury status (если есть), недельная статистика по всем скоринговым метрикам.
- **Индикатор травмы**: Если игрок имеет injury, пользователь это видит. Draft возможен, но желателен warning.

### 3.2 Структура команды

```ts
interface FantasyTeam {
  userId: string;
  teamName: string;
  week: number;
  roster: [
    {slot: 'LW', playerId: string | null},
    {slot: 'C', playerId: string | null},
    {slot: 'RW', playerId: string | null},
    {slot: 'D1', playerId: string | null},
    {slot: 'D2', playerId: string | null},
    {slot: 'G', playerId: string | null}
  ];
  totalSalary: number;
}
```

## 4. Система начисления очков ("scoring")

### 4.1 Скоринг для Skater

- Goals (G): 5
- Assists (A): 3
- Plus/Minus (+/-): 1 * (+1/-1, по каждому разу)
- Penalty Minutes (PIM): -0.3
- Power Play Goals (PPG): 0.5
- Power Play Assists (PPA): 0.3
- Short Handed Goals (SHG): 2
- Short Handed Assists (SHA): 1
- Game-Winning Goals (GWG): 1
- Faceoffs Won (FOW): 0.1
- Faceoffs Lost (FOL): -0.05
- Hat Tricks (HAT): 4
- Shots on Goal (SOG): 0.3
- Hits (HIT): 0.55
- Blocked Shots (BLK): 0.55
- Defensemen Points (DEF): 0.65 (только для защитников — по каждому набранному очку)

### 4.2 Скоринг для Goaltender

- Games Started (GS): 1.5
- Wins (W): 2.5
- Losses (L): -1
- Goals Against (GA): -1.8
- Saves (SV): 0.35
- Shutouts (SO): 8
- Overtime Losses (OTL): 0.3

### 4.3 Отчетность и UI

- В личном кабинете каждого пользователя вся детализация начислений выводится с разбивкой по каждому игроку и типу очков.
- Итог недели фиксируется системой в leaderboard и суммируется в сезонный рейтинг.

## 5. Безопасность и надежность

- JWT/cookie auth.
- API rate limiting, CSRF — на всех критически важных точках.
- Атомарные транзакции на действия draft pick, forced-pick, kick, undo, leaderboard update.
- Rollback и fallback механизмы на случай сбоя основного source API — автоматический переход на резервный.

## 6. UI/UX и Edge Cases

- Draft Board (реальное время): все пики прозрачны, можно видеть составы всех команд.
- All Teams View: после завершения недели — просмотр итоговых составов.
- Специндикаторы: для reconnect, auto-pick, forced-pick; динамическое обновление статусов.
- Грубые ошибки (salary cap exceeded, уже выбран игрок, не ваша очередь) — резкая индикация, ошибки не допускаются до сервера.

## 7. Тестирование

- Unit и e2e тесты: покрытие мультипозиций, начислений очков, reconnect, forced-pick, race pick, ошибочного поведения.
- Load и edge case: поведение под нагрузкой, сбои API, гонки при одновременных пиках, некорректные входные данные.
- Фиксация всех критичных админ-событий и изменений leaderboard в аудит-логах (доступ через админ-портал).

## 8. Вопросы для ревью и доработок

1. Тест-кейсы на повторное использование мультипозиционного игрока: обеспечена невозможность дубля на одну и ту же неделю.
2. Зафиксированная публичная скоринговая формула; возможность ее изменения через конфиг (на случай смены политики лиги).
3. Injury status: при появлении данных — поддержка warning/фильтрации при драфте.
4. Полностью формализованный и протестированный fallback на резервный API.
5. UI-индикация всех нестандартных сценариев: reconnect, forced-pick, auto-pick/user-pick (отвечает новым UX-гайдам).
6. Стандартизация и анализ аудит-логов всех критичных событий.
7. Номинация MVP/Best pick/Other awards не требуется на текущем этапе, но могут быть заложены в roadmap.

**Данный документ является пред-финальной спецификацией и используется как условие допуска любой новой задачи к разработке.**
**Если не покрыта хотя бы одна из указанных зон — задача возвращается на доработку.**