# Требования и бизнес-логика — Fantasy Draft App (NHL)

**Версия:** 1.0  
**Дата:** 2025-10-20  
**Статус:** Актуально

---

## 1. Обзор проекта

### 1.1. Цель
Создать некоммерческое веб-приложение для проведения fantasy hockey драфта с системой salary cap, предназначенное для небольшой компании друзей (10-100 человек).

### 1.2. Ключевые принципы
- **Простота:** Понятный интерфейс, минимум настроек
- **Доступность:** Друзья могут зайти из любой точки мира по логину/паролю
- **Сохранность:** Все данные (команды, составы, статистика) сохраняются и доступны между драфтами
- **Надёжность:** Защита от конфликтов при одновременных действиях
- **Энтузиазм:** Проект на энтузиазме, не коммерческий

### 1.3. Ограничения
- Целевая аудитория: 10-100 человек
- Не требуется enterprise-уровень безопасности и отказоустойчивости
- Фокус на функциональности, а не на масштабируемости

---

## 2. Функциональные требования

### 2.1. Регистрация и аутентификация

#### Регистрация нового пользователя
- Пользователь вводит: логин, пароль, название команды, выбирает логотип
- Логин должен быть уникальным
- Пароль хэшируется перед сохранением
- После регистрации пользователь автоматически авторизуется

#### Вход в систему
- Пользователь вводит логин и пароль
- Проверка хэша пароля
- Создание сессии (cookie/JWT)
- Переход в личный кабинет

#### Выход
- Завершение сессии
- Редирект на страницу входа

### 2.2. Команды

#### Создание команды
- Название команды (уникальное в рамках лиги)
- Логотип (выбор из шаблонов или загрузка)
- Привязка к пользователю (owner_id)

#### Состав команды
- Максимум 6 игроков
- Total salary не должен превышать $95,500,000
- Состав блокируется после завершения драфта (lock-in)
- Изменение состава возможно только в следующем драфте

### 2.3. Драфт

#### 2.3.1. Лобби ожидания

**Вход в лобби:**
- Пользователи заходят в лобби после авторизации
- Видят список всех участников (логин, название команды, логотип)
- Видят статус каждого участника (ready/not ready)

**Готовность к старту:**
- Участники могут отметить себя как "готов" (опционально)
- Администратор/создатель видит общий статус готовности

**Запуск драфта:**
- Вариант 1: По кнопке "Старт драфта" (только администратор/создатель)
- Вариант 2: По таймеру в определённое время (например, 20:00 МСК)
- После старта все переходят в draft-комнату

#### 2.3.2. Draft-комната

**Отображение информации:**
- Таблица всех доступных игроков (имя, фамилия, позиция, зарплата, команда NHL, статистика)
- Очередь пиков (кто сейчас ходит, кто следующий)
- Таймер обратного отсчёта (60 секунд на выбор)
- История выбранных игроков (pick history)
- Текущий состав своей команды
- Оставшийся salary cap для своей команды
- Leaderboard (все команды с их total salary)

**Механика выбора:**
- Выбирать могут только в свой ход (валидация на сервере)
- Нельзя выбрать игрока, который уже выбран другой командой
- Нельзя выбрать игрока, если его зарплата превысит лимит salary cap
- При нарушении правил — сообщение об ошибке

**Автопик:**
- Если время истекло (60 сек), сервер автоматически выбирает игрока:
  - Вариант 1: Random из доступных
  - Вариант 2: Топ-игрок по зарплате из доступных
- Все участники видят уведомление об автопике
- Драфт продолжается со следующего участника

#### 2.3.3. Правила драфта

**Тип драфта:** Snake draft
- Раунд 1: Участники 1 → 2 → 3 → 4 (прямой порядок)
- Раунд 2: Участники 4 → 3 → 2 → 1 (реверс)
- Раунд 3: Участники 1 → 2 → 3 → 4 (прямой)
- И так далее до 6 раундов (6 игроков на команду)

**Таймер:**
- 60 секунд на каждый пик
- Таймер отсчитывается на сервере (не на клиенте!)
- При истечении — автопик
- Таймер можно ставить на паузу (только администратор)

**Salary cap:**
- Лимит: $95,500,000 на команду
- Проверка при каждом выборе
- Если превышение — выбор отклоняется с сообщением об ошибке

**Завершение драфта:**
- Драфт завершается, когда все команды выбрали по 6 игроков
- Составы блокируются (lock-in)
- Обновляется leaderboard
- Участники могут просматривать результаты

### 2.4. Таблица игроков

#### Отображение
- Имя, Фамилия
- Позиция (C, LW, RW, D, G)
- Зарплата (cap hit) в $
- Команда NHL
- Статистика за прошлый сезон: игры, голы, передачи, очки

#### Фильтры и сортировка
- Фильтр по позиции (C, LW, RW, D, G)
- Фильтр по команде NHL
- Сортировка по зарплате (по убыванию/возрастанию)
- Сортировка по статистике (голы, очки)
- Поиск по имени/фамилии

#### Статус игрока
- Доступен (drafted_by = null) — можно выбрать
- Задрафчен (drafted_by = user_id) — отображается серым, недоступен для выбора

### 2.5. Leaderboard (Таблица результатов)

#### Отображение
- Все команды участников
- Название команды, владелец (логин)
- Total salary команды
- Список игроков в команде (имя, позиция, зарплата)
- Сортировка по total salary (по убыванию)

#### Обновление
- Обновляется после каждого пика в real-time
- Доступен для просмотра после завершения драфта

### 2.6. Личный кабинет

#### Моя команда
- Название команды, логотип
- Список выбранных игроков (имя, позиция, зарплата)
- Total salary команды
- Оставшийся salary cap (если драфт не завершён)

#### История
- История своих пиков (раунд, номер пика, игрок)
- Когда был задрафчен каждый игрок

---

## 3. Сценарии использования

### 3.1. Новый пользователь регистрируется и участвует в драфте

1. Пользователь переходит на сайт
2. Нажимает "Регистрация"
3. Вводит логин, пароль, название команды, выбирает логотип
4. Система проверяет уникальность логина и создаёт аккаунт
5. Пользователь автоматически авторизуется
6. Попадает в лобби драфта, видит других участников
7. Отмечает себя как "готов" (опционально)
8. Ждёт старта драфта (по кнопке администратора или по таймеру)
9. Драфт начинается, пользователь переходит в draft-комнату
10. В свой ход выбирает игрока из таблицы
11. Система проверяет salary cap и доступность игрока
12. Игрок добавляется в команду, таймер переходит к следующему участнику
13. Повторяется до 6 раундов
14. После завершения — просмотр своей команды и leaderboard

### 3.2. Пользователь пропускает свой ход

1. Наступает ход пользователя
2. Пользователь не выбирает игрока в течение 60 секунд
3. Система автоматически выбирает игрока (автопик)
4. Все участники видят уведомление "Автопик: [Пользователь] → [Игрок]"
5. Ход переходит к следующему участнику

### 3.3. Пользователь пытается выбрать игрока, превышающего salary cap

1. Пользователь выбирает игрока
2. Система проверяет: текущий salary + зарплата игрока > $95,500,000
3. Система отклоняет выбор
4. Отображается сообщение: "Salary cap exceeded! У вас осталось $X, а игрок стоит $Y"
5. Пользователь выбирает другого игрока

### 3.4. Два пользователя одновременно пытаются выбрать одного игрока

1. Пользователь A и пользователь B (оба в свой ход) кликают на одного игрока одновременно
2. Сервер получает два запроса
3. Сервер обрабатывает первый запрос: игрок блокируется для A
4. Сервер обрабатывает второй запрос: проверка показывает, что игрок уже задрафчен
5. Пользователю B отображается сообщение: "Player already picked!"
6. Пользователь B выбирает другого игрока

---

## 4. Правила и ограничения

### 4.1. Salary cap
- **Лимит:** $95,500,000 на команду (6 игроков)
- **Проверка:** При каждом выборе игрока
- **Нарушение:** Выбор отклоняется, отображается ошибка
- **Валидация:** На сервере (не на клиенте!)

### 4.2. Уникальность выбора
- Каждый игрок может быть выбран только одной командой
- После выбора игрок блокируется для всех остальных
- Попытка выбрать задрафченного игрока отклоняется

### 4.3. Очерёдность
- Выбирать можно только в свой ход
- Попытка выбрать не в свой ход отклоняется
- Порядок определяется snake draft (реверс в чётных раундах)

### 4.4. Lock-in составов
- После завершения драфта составы блокируются
- Изменение состава невозможно до следующего драфта
- **НЕ ТРЕБУЕТСЯ** ручная корректировка составов администратором

### 4.5. Таймер
- 60 секунд на выбор
- Отсчитывается на сервере
- При истечении — автопик
- Администратор может ставить на паузу (при необходимости)

---

## 5. UI/UX требования

### 5.1. Страница регистрации
- Поля: логин, пароль, название команды
- Выбор логотипа (галерея шаблонов)
- Кнопка "Зарегистрироваться"
- Ссылка "Уже есть аккаунт? Войти"

### 5.2. Страница входа
- Поля: логин, пароль
- Кнопка "Войти"
- Ссылка "Нет аккаунта? Зарегистрироваться"

### 5.3. Лобби драфта
- Список участников (логин, команда, логотип, статус ready)
- Кнопка "Готов" (для участника)
- Кнопка "Старт драфта" (только для администратора)
- Таймер старта (если настроен автоматический старт)

### 5.4. Draft-комната
- **Левая панель:** Таблица игроков (фильтры, сортировка, поиск)
- **Центр:** Очередь пиков, таймер, уведомления
- **Правая панель:** Моя команда, salary cap индикатор, history
- **Нижняя панель:** Leaderboard (скрываемый)

### 5.5. Индикация состояний
- "Your turn" — зелёная подсветка, когда ваш ход
- Таймер — красный при <10 секунд
- Salary cap — красный при <$5,000,000 остатка
- Заблокированные игроки — серый цвет, disabled

### 5.6. Уведомления
- "Игрок [X] выбран командой [Y]"
- "Ваш ход!"
- "Автопик: [Игрок]"
- "Драфт завершён!"
- Ошибки: "Salary cap exceeded!", "Player already picked!", "Not your turn!"

---

## 6. НЕ требуется для MVP

❌ **Ручная корректировка составов** после драфта (lock-in до следующего драфта)  
❌ **Чат** между участниками  
❌ **Экспорт результатов** (CSV/Excel)  
❌ **Мобильное приложение** (только веб)  
❌ **OAuth/социальные сети** для входа  
❌ **SMS/Email-верификация**  
❌ **Push-уведомления**  
❌ **Расширенная статистика** и аналитика  
❌ **Обмен игроками** после драфта  
❌ **Waiver wire** и free agency  

---

## 7. Критерии приёмки

### 7.1. Регистрация и вход
- ✅ Пользователь может зарегистрироваться с уникальным логином
- ✅ Пользователь может войти с правильными логином/паролем
- ✅ Пароль хэшируется, не хранится в открытом виде

### 7.2. Драфт
- ✅ Драфт запускается по кнопке администратора
- ✅ Snake draft работает корректно (реверс в чётных раундах)
- ✅ Таймер отсчитывает 60 секунд на каждый пик
- ✅ Автопик срабатывает при истечении времени
- ✅ Salary cap проверяется при каждом выборе
- ✅ Нельзя выбрать игрока, который уже задрафчен
- ✅ Нельзя выбрать не в свой ход

### 7.3. Real-time обновления
- ✅ Все участники видят выборы других в real-time
- ✅ Таймер синхронизирован для всех
- ✅ Leaderboard обновляется после каждого пика

### 7.4. Данные
- ✅ Составы сохраняются после завершения драфта
- ✅ Данные доступны после перезагрузки страницы
- ✅ Leaderboard доступен для просмотра после драфта

---

## 8. Источники данных

### 8.1. Игроки NHL
- **Источник:** capwages.com (или puckpedia.com)
- **Поля:** first_name, last_name, position, cap_hit, team, stats
- **Обновление:** Перед началом драфта (ручной запуск скрипта)

### 8.2. Статистика
- **Источник:** Статистика за прошлый сезон из того же источника
- **Поля:** games, goals, assists, points

---

## 9. Глоссарий

- **Draft** — процесс выбора игроков командами
- **Snake draft** — тип драфта с реверсом очереди в чётных раундах
- **Salary cap** — лимит на суммарную зарплату команды ($95,500,000)
- **Cap hit** — годовая зарплата игрока, учитываемая в salary cap
- **Pick** — выбор игрока
- **Автопик** — автоматический выбор игрока при истечении времени
- **Lock-in** — блокировка состава после завершения драфта
- **Leaderboard** — таблица результатов всех команд
